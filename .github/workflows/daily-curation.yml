name: Daily Music News Curation

on:
  schedule:
    - cron: '0 0 * * *' # æ¯æ—¥ JST 9:00 (UTC 0:00) ã«å®Ÿè¡Œ
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œç”¨

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  curate-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install

      - name: Run AI Curation
        env:
          BRAVE_SEARCH_API_KEY: ${{ secrets.BRAVE_SEARCH_API_KEY }}
          GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }} # Perplexity APIã‚­ãƒ¼ã‚’è¿½åŠ 
        run: pnpm run curate

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          ls -la src/data/
          
          # ä¸‡ãŒä¸€ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ç©ºã®JSONã‚’ä½œæˆã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’å›é¿
          if [ ! -f src/data/news.json ]; then
            echo "[]" > src/data/news.json
          fi

          git add src/data/news.json
          # å¤‰æ›´ãŒãªã„å ´åˆã¯ã‚³ãƒŸãƒƒãƒˆã—ãªã„
          git commit -m "ğŸ¤– Update music news data" || exit 0
          git push

      - name: Build Next.js
        run: pnpm run build

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
